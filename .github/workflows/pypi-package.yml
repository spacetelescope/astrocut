name: Building & Publishing

on:
  push:
    branches: [main]
    tags: ["*"]
  release:
    types:
      - published

permissions:
  contents: read
  id-token: write

jobs:

  # TODO: Make it so that this only executes when publish-to-test-pypi executes
  # TODO: Make it so that the tag gets deleted after publish-to-test-pypi finishes executing
  make_tag:
    runs-on: ubuntu-latest

    steps:
    - name: Make a release tag
      run: git tag -a v0.10.0dev -m "dev release"

  # Release to Test PyPI after every MERGE into @spacetelescope/astrocut/main    
  publish-to-test-pypi:
    uses: OpenAstronomy/github-actions-workflows/.github/workflows/publish.yml@v1
    name: Publish to Test PyPI
    needs: make_tag

    if: github.repository_owner == 'spacetelescope' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    with:
      # We DON'T want to upload to the official PyPI for this job
      repository_url: https://test.pypi.org/legacy/

  # Release to PyPI after a RELEASE gets PUBLISHED in @spacetelescope/astrocut/main
  publish-to-pypi:
    uses: OpenAstronomy/github-actions-workflows/.github/workflows/publish.yml@v1
    name: Publish to PyPI

    if: github.repository_owner == 'spacetelescope' && github.event.action == 'published'
    with:
      repository_url: https://pypi.org/legacy/